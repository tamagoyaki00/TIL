## 2025-10-01学習記録
学習時間9.1時間（総合学習時間1009.8）+ 本日1.5時間計測し忘れ

TO DO
- [x] 本番環境で通知が来ないバグ修正
- [x] 日記一覧の写真を押すと、拡大表示できる機能を追加
- [x] ブラウザを閉じても、ログインが維持される機能を追加
- [x] ログイン状態に応じて、ルートページを変更
- [x] 細かなレイアウト修正

## 学習時間1000時間達成～！！  
記録している時間はどこかで計算し間違えてたみたいなんですが、RUNTEQで測っている方で1000時間達成してましたー！
MVPも完成し、明日提出する予定なので、なんだか感慨深いですね。  
学生のときでもこんなに勉強していなかった気がするので勉強できるか不安でしたが、やってみると全然問題なく継続できてました！(笑)

## 学び
### プッシュ通知
本番環境で通知が来ないバグについてですが、RenderCronJobの設定は問題なさそうだったので、ユーザーを取得しているところが怪しいなとおもい、デバッグを追加し調査しました。  
結論、DBのタイムゾーンと現在の時刻を取得するタイムゾーンが異なっていたことが原因  
Railsは時間の管理がいくつかあるんですよね。  
参考記事：https://qiita.com/aosho235/items/a31b895ce46ee5d3b444

config/application.rbに以下を設定しており、開発環境では問題なく通知が届いていたので、勝手にJSTで一致しているものだとおもっていたのですが、まさかの開発環境のDBはJST、本番環境のDBはUTCでした。
```
config.time_zone = "Asia/Tokyo"
config.active_record.default_timezone = :local
```

参考記事にあるとおり、国内のアプリなので、すべてをJSTに統一しようとおもって
```
-- 永続的にデータベースのタイムゾーンを変更するには
ALTER DATABASE d1 SET TIMEZONE TO 'Asia/Tokyo';
```
を実行したのですが、反映されず。NeonのタイムゾーンはUTC固定ぽいです・・。

次に公式ドキュメント（https://neon.com/postgresql/postgresql-date-functions/postgresql-at-time-zone ）にあるように
`AT TIME ZONE 'Asia/Tokyo'`を明示したらJSTになるのでは？とおもいやってみましたが、これでも変わらず。。  
おそらくこれは`time型`で扱っている値で、日付がはいっていないのが原因。

よし、JSTに統一するのはあきらめた！ユーザーに表示するタイムゾーンはJSTで、内部はUTCで管理しよう！ということで修正したら、無事プッシュ通知が届きました～！（長かった）

### ブラウザを閉じても、ログインが維持される機能
最近同期の方が話していた、deviseのremember_meの話。
デプロイするごとにユーザーが再度ログインを強いられるのを改善したい！ということで私も実装しました。
私の場合は、
Userモデルに
```
def remember_me
  true
end
```
を定義することで、ログインした全ユーザーのログイン状態を維持するようにしました。
ちょっと調べただけなので、間違っているかもしれませんが、
- コントローラーに記述するとログイン時の次回から自動でログインにユーザーがチェックすることで、ログインの状態が保持される。
- モデルに設定すると、ユーザーのチェックの有無ではなく、ログインしたユーザー全員のログインの状態が保持される。
という違いみたいです。

コントローラーの記述方法は、是非、YutoさんのQiitaをご覧ください！

### ログイン状態に応じて、ルートページを変更

routes.rbに以下を追加
```
authenticated :user do
  root to: "homes#index", as: :authenticated_root
end

unauthenticated do
  root to: "pages#top", as: :unauthenticated_root
end
  ```

authenticated :user は Devise が提供しているメソッドで、ユーザーのログイン状態（user_signed_in?） を見てルーティングを切り替えてくれます。

上記の意味は、ユーザーがログインしている場合は"homes#index"にアクセス、未ログインの場合は"pages#top"のページを表示するという意味です。