## 2025-11-20学習記録

テストのカバレッジを計測するgem`gem 'simplecov', require: false`をインストール
現状約70％でした。一旦目標を80％として、追加できるテストを追加していきます。

今まで、modelとsystemしかテストを書いていませんでしたが、他のテストも書いてみようと思います。

まず、通知設定に関すること。これはOneSignalが絡む＋OneSignal側の設定のURLを本番環境（1つのみしか登録できない）にしているので開発環境では通知ONのトグルの切り替えもできない為、システムスペックも書いていませんでした。
こちらに関しては、Requestスペックテスト書くことで、HTTPのレスポンスのステータスコードなどを確認することにより、ある程度の動作をテストで保証することができました。
リクエストスペックテストを初めて書いたのですが、参考にした動画では基本的にはシステムスペックでいいが、API通信などテストしにくい部分をリクエストスペックでかくといいとのことでした！

次にDiaryReminderJobに関するテスト  
ここでは、通知onにしたユーザーかつ、現在時刻が一致するユーザーを取得し`send_one_signal_notification`が呼ばれるかどうかのテストを行います。`send_one_signal_notification`メソッドの中身ではOneSignalにAPI通信を行い、日記のリマインダーを送る処理を書いています。実際通知が送られているかどうかは本番環境で確認しているので、テストではかきません。
```
require 'rails_helper'

RSpec.describe DiaryReminderJob, type: :job do
let!(:user_on_time) do
  create(:user).tap do |u|
    u.notification_setting.update!(
      reminder_enabled: true,
      notification_time: Time.zone.parse("09:00"),
      scene_type: :preset,
      scene_name: "朝のスタート"
    )
  end
end

  let!(:user_off) {create(:user)}

  it "通知ONかつ時間一致ユーザーのみAPI通信される" do
    job = DiaryReminderJob.new
    allow(job).to receive(:send_one_signal_notification)

    travel_to Time.zone.parse("09:00") do
      job.perform
    end

    expect(job).to have_received(:send_one_signal_notification).with(user_on_time)
  end
end

```
### Active Jobのテストの書き方  
ファイル名：spec/jobs/<job名>_job__spec.rb  
type: :job  
解説：  
job = DiaryReminderJob.new  
- 本番では ActiveJob が自動的にインスタンスを作って実行するが、テストでは手動で new している。

allow(...).to receive
- RSpecのモック機能
- job オブジェクトに対して send_one_signal_notification メソッドが呼ばれても、実際の処理は行わずに「呼ばれた」という記録だけ残す。

travel_to
- Rails のテスト用ヘルパー。現在時刻を一時的に「09:00」に固定する。

job.perform
- ジョブの処理を実行する。

expect(...).to have_received(...)
- RSpec の「スパイ」機能。
- 先ほど記録を残すようにしたので、ここで「実際に呼ばれたか」を検証できる。

モックについて理解を深めたく
参考記事: https://qiita.com/jnchito/items/640f17e124ab263a54dd を読んだがそこでは、`double`をつかってモックオブジェクトをつくると記載があり、私のテストにはないので何が違うかを調べてみた。

モックをオブジェクトを作成すると、処理のすべてが、モック化＝偽の処理が走る  
今回のテストのように、一部をモック化する＝ 本物の処理は走るが、特定のメソッドだけ「代替え」にしている。

今回の例でいくと、ユーザーの取得などはテストせずにAPI通信が呼ばれるかどうかだけを確認したいときは`double`を使う