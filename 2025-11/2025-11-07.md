## 2025-11-07学習記録

TODO
- [x] ユーザー名・アバターからプロフィール詳細画面に遷移できるテストを追加
- [x] N＋1問題がでたので、再度修正
- [x] 一か月の振り替えりをDBに保存していたのを、メソッド集計に変更
- [x] 幸せ瓶の満タンの個数を変更

一か月の振り返りですが、日記の編集や削除があった際に、一か月の振り返りのデータの整合性が保たれないので、メソッド集計に変更しました。また、diaryを外部キーにして、最大の幸せ数の日記を取得していたのですが、それをDBに保存していると、その日記が削除できないことに気づきました。そういう時は、外部キーにするのではなく、コピーして保存するのがいいみたいですね。
個人開発でそこまでデータも多くないので、メソッド集計にしてもデータの取得は今のところ早いです。

N＋1問題ですが、ユーザーを取得するという意識はありましたが、私の日記一覧ではdiary_contentやtagやアバターなどいろいろの要素があり、すべて別テーブルなので、そうか！別テーブルならincludesしないとだめなんだと気づかされました。
active storageのアバターはuserを含んでも一緒に取得してくれないので`user: :avatar_attachment`のように追加する必要がある。


明日TODO
- [ ] 幸せ瓶の満タンの個数を変更の続き